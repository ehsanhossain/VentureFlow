name: Deploy to Production

# When does this run?
on:
  push:
    branches: [main]
    paths:
      - "ventureflow-backend/**"
      - "ventureflow-frontend/**"
      - ".github/workflows/deploy.yml"
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

# Give the workflow permission to push to the deploy branch
permissions:
  contents: write

# What does it do?
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Download the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js for building React
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ventureflow-frontend/package-lock.json

      # Step 3: Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: ventureflow-frontend
        run: npm ci

      # Step 4: Build the React frontend
      - name: Build frontend
        working-directory: ventureflow-frontend
        env:
          VITE_API_BASE_URL: "/"
        run: npm run build

      # Step 5: Set up PHP for Composer
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      # Step 6: Prepare the deploy folder
      - name: Prepare deployment
        run: |
          mkdir -p deploy

          # Copy backend files (excluding dev/unnecessary files)
          rsync -av \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='*.sqlite' \
            --exclude='*.sqlite3' \
            --exclude='database/database.sqlite' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='docker-compose.yml' \
            --exclude='Dockerfile' \
            --exclude='phpunit.xml' \
            --exclude='test-*.php' \
            --exclude='test-*.ps1' \
            --exclude='test_*.php' \
            --exclude='last_error.txt' \
            --exclude='verification-report.php' \
            --exclude='ventureflow_production.sql' \
            --exclude='storage/logs/*.log' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            ventureflow-backend/ deploy/

          # Copy built frontend into public/
          cp -rf ventureflow-frontend/dist/* deploy/public/

          # Copy deployment automation hook into public/
          cp -f "Deployment automation/test.php" deploy/public/test.php

          # Ensure storage directories exist with .gitkeep
          mkdir -p deploy/storage/app/public
          mkdir -p deploy/storage/framework/cache/data
          mkdir -p deploy/storage/framework/sessions
          mkdir -p deploy/storage/framework/views
          mkdir -p deploy/storage/logs
          mkdir -p deploy/bootstrap/cache
          touch deploy/storage/app/public/.gitkeep
          touch deploy/storage/framework/cache/data/.gitkeep
          touch deploy/storage/framework/sessions/.gitkeep
          touch deploy/storage/framework/views/.gitkeep
          touch deploy/storage/logs/.gitkeep
          touch deploy/bootstrap/cache/.gitkeep

          echo "=== Deploy folder contents ==="
          ls -la deploy/
          echo "=== Deploy public/ contents ==="
          ls -la deploy/public/

      # Step 7: Install PHP dependencies (production only)
      - name: Install Composer dependencies
        working-directory: deploy
        run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

      # Step 8: Ensure vendor/ is NOT gitignored (it must be deployed!)
      - name: Prepare for deployment push
        run: |
          # Remove vendor from .gitignore so it gets pushed to deploy branch
          if [ -f deploy/.gitignore ]; then
            sed -i '/^\/vendor/d' deploy/.gitignore
            sed -i '/^vendor/d' deploy/.gitignore
          fi

          # Create production .env file
          cat > deploy/.env << 'ENVFILE'
          APP_NAME=VentureFlow
          APP_ENV=production
          APP_KEY=base64:VQlRnu+RInHur1PRi/ki3zNvAhkorb9BouqQNzwp3Yo=
          APP_DEBUG=false
          APP_URL=https://ventureflow.app
          APP_VERSION=1.0.0
          APP_DEVELOPER="VentureFlow"

          SANCTUM_STATEFUL_DOMAINS=ventureflow.app
          FRONTEND_URL=https://ventureflow.app

          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US

          APP_MAINTENANCE_DRIVER=file

          BCRYPT_ROUNDS=12

          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=VF_alpha
          DB_USERNAME=VF_alpha
          DB_PASSWORD=alpha_vf
          DB_CHARSET=utf8mb4
          DB_COLLATION=utf8mb4_unicode_ci

          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=ventureflow.app
          SESSION_SAME_SITE=lax
          SESSION_SECURE_COOKIE=true

          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync

          CACHE_STORE=database

          MAIL_MAILER=smtp
          MAIL_SCHEME=null
          MAIL_HOST=ventureflow.app
          MAIL_PORT=465
          MAIL_USERNAME=no_reply@ventureflow.app
          MAIL_PASSWORD="6f!Tx2m85"
          MAIL_ENCRYPTION=ssl
          MAIL_FROM_ADDRESS="no_reply@ventureflow.app"
          MAIL_FROM_NAME="${APP_NAME}"

          VITE_APP_NAME="${APP_NAME}"
          ENVFILE

          # Remove leading spaces from .env (heredoc indentation)
          sed -i 's/^          //' deploy/.env

          # Verify
          echo "=== .gitignore (no vendor line) ==="
          cat deploy/.gitignore | head -20
          echo ""
          echo "=== vendor/ exists ==="
          ls deploy/vendor/ | head -5
          echo ""
          echo "=== .env created ==="
          head -5 deploy/.env

      # Step 9: Push to the deploy branch
      - name: Deploy to deploy branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          publish_branch: deploy
          force_orphan: true
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"
