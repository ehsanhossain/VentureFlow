name: Deploy to Production

# When does this run?
on:
  push:
    branches: [main]
    paths:
      - "ventureflow-backend/**"
      - "ventureflow-frontend/**"
      - ".github/workflows/deploy.yml"
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

# Give the workflow permission to push to the deploy branch
permissions:
  contents: write

# What does it do?
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Download the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js for building React
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ventureflow-frontend/package-lock.json

      # Step 3: Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: ventureflow-frontend
        run: npm ci

      # Step 4: Build the React frontend
      - name: Build frontend
        working-directory: ventureflow-frontend
        run: npm run build

      # Step 5: Set up PHP for Composer
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      # Step 6: Prepare the deploy folder
      - name: Prepare deployment
        run: |
          mkdir -p deploy

          # Copy backend files (excluding dev/unnecessary files)
          rsync -av \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='*.sqlite' \
            --exclude='*.sqlite3' \
            --exclude='database/database.sqlite' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='docker-compose.yml' \
            --exclude='Dockerfile' \
            --exclude='phpunit.xml' \
            --exclude='test-*.php' \
            --exclude='test-*.ps1' \
            --exclude='test_*.php' \
            --exclude='last_error.txt' \
            --exclude='verification-report.php' \
            --exclude='ventureflow_production.sql' \
            --exclude='storage/logs/*.log' \
            --exclude='storage/framework/cache/data/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            ventureflow-backend/ deploy/

          # Copy built frontend into public/
          cp -rf ventureflow-frontend/dist/* deploy/public/

          # Ensure storage directories exist with .gitkeep
          mkdir -p deploy/storage/app/public
          mkdir -p deploy/storage/framework/cache/data
          mkdir -p deploy/storage/framework/sessions
          mkdir -p deploy/storage/framework/views
          mkdir -p deploy/storage/logs
          mkdir -p deploy/bootstrap/cache
          touch deploy/storage/app/public/.gitkeep
          touch deploy/storage/framework/cache/data/.gitkeep
          touch deploy/storage/framework/sessions/.gitkeep
          touch deploy/storage/framework/views/.gitkeep
          touch deploy/storage/logs/.gitkeep
          touch deploy/bootstrap/cache/.gitkeep

          echo "=== Deploy folder contents ==="
          ls -la deploy/
          echo "=== Deploy public/ contents ==="
          ls -la deploy/public/

      # Step 7: Install PHP dependencies (production only)
      - name: Install Composer dependencies
        working-directory: deploy
        run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

      # Step 8: Push to the deploy branch
      - name: Deploy to deploy branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          publish_branch: deploy
          force_orphan: true
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"
